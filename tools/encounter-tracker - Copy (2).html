<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>PF2 Encounter Manager</title>
<script src="https://unpkg.com/vue@3"></script>

<style>
  /* ---------- colours & fonts ---------- */
  :root{
  --hp-bg:#402427;
  --hp-bar:#ff8a80;   /* pastel red */
  }
  body{background:#111;color:#ddd;font-family:"Segoe UI",Tahoma,sans-serif;margin:0;padding:1em;}
  h2,h3{color:#f5ba42;margin:.3em 0;}
  input,select,button,textarea{
    background:#222;color:#eee;border:1px solid #555;border-radius:4px;
    padding:.45em;margin:.2em;font:inherit;
  }
  textarea{resize:vertical;} button:hover{background:#333;}

  /* ---------- add-form ---------- */
  .add-form{display:flex;flex-wrap:wrap;gap:.4em;align-items:flex-start;}
  .add-form select,.add-form input[type=text],.add-form input[type=number]{width:9.5em;}
  .add-form textarea{width:18em;min-height:3.8em;}

  /* ---------- initiative table ---------- */
  table{width:100%;border-collapse:collapse;margin-top:.8em;}
  th,td{border:1px solid #444;padding:.55em;text-align:left;vertical-align:top;}
  tr.active{background:#2a2f33;font-weight:bold;}
  tr.dead{color:#777;text-decoration:line-through;}
  .color-dot{display:inline-block;width:1em;height:1em;border-radius:50%;margin-right:.35em;}

  /* quick stats bar */
  .stat-sum{display:flex;align-items:center;gap:.35em;font-size:.78em;margin-top:.25em;}
  .stat-box{background:#555;border-radius:3px;padding:.05em .35em;display:flex;align-items:center;gap:.2em;}
  .stat-box b{font-weight:700;}
  .hp-wrap{flex:1;position:relative;height:8px;background:var(--hp-bg);border-radius:4px;overflow:hidden;}
  .hp-bar{position:absolute;top:0;left:0;bottom:0;background:var(--hp-bar);}

  /* status pills */
  .status-tag{display:inline-block;background:#444;color:#fff;border-radius:9999px;font-size:.75em;padding:.1em .6em;margin:.15em;cursor:pointer;}
  .status-tag:hover{background:#666;}

  /* big buttons */
  .big-btn{margin-top:1em;padding:1em 2em;font-size:1.05em;border:none;border-radius:6px;cursor:pointer;}
  .start-btn,.next-btn{background:#f5ba42;color:#111;} .start-btn:hover,.next-btn:hover{background:#e5a832;}
  .end-btn{background:#c94a4a;color:#fff;} .end-btn:hover{background:#b23d3d;}
  .clear-btn{background:#555;color:#fff;} .clear-btn:hover{background:#666;}

  /* stat-card */
  .stat-block{background:#222;border:1px solid #555;border-radius:6px;padding:1em;margin-top:1em;}
  .stat-block pre{white-space:pre-wrap;margin:0;}
  .stat-card{font-family:serif;line-height:1.35;font-size:0.93em;}
  .stat-card h4{margin:.1em 0 .3em;font-size:1.15em;font-weight:700;text-transform:uppercase;}
  .stat-tags span{display:inline-block;padding:.05em .4em;margin-right:.25em;border-radius:2px;font-size:.68em;color:#fff;font-weight:700;letter-spacing:.02em;}
  .tag-NE{background:#3949ab}.tag-LG{background:#2e7d32}.tag-CE{background:#c62828}
  .tag-Medium{background:#4caf50}.tag-Large{background:#8d6e63}.tag-Small{background:#42a5f5}
  .tag-Aberration{background:#7b1fa2}.tag-Undead{background:#6d4c41}
  .stat-section{border-top:1px solid #555;margin-top:.45em;padding-top:.35em;}
  .stat-card ul{margin:.3em 0 .2em 1.2em;padding:0;}
  .action-icon{font-weight:700;border:1px solid #777;border-radius:2px;padding:0 .18em;font-size:.66em;margin-right:.25em;}
  .act-single{background:#444}.act-two{background:#555}.act-three{background:#666}

  /* accordions */
  details.box{background:#1b1b1b;border:1px solid #333;border-radius:8px;padding:1em;margin-top:1.6em;}
  details.box summary{cursor:pointer;font-size:1.08em;color:#f5ba42;padding:.4em 0;}
  details.box textarea{width:100%;height:10em;}

  /* mobile */
  @media(max-width:600px){
    .add-form textarea{width:100%;}
    table{font-size:.88em;} input[type=number]{width:4em;}
  }
</style>
</head>
<body>
<div id="app">

  <h2>Initiative Tracker</h2>

  <!-- SAVE / LOAD / CLEAR -->
  <div v-if="!combatStarted" style="margin-bottom:.6em;">
    <input v-model="saveName" placeholder="Encounter name" style="width:12em;">
    <button @click="saveEncounter">üíæ Save</button>

    <select v-model="selectedSave">
      <option value="" disabled selected>Load saved‚Ä¶</option>
      <option v-for="n in savedList" :key="n" :value="n">{{n}}</option>
    </select>
    <button v-if="selectedSave" @click="loadEncounter">‚≠Ø Load</button>
    <button v-if="selectedSave" @click="deleteEncounter" style="color:#c94a4a">üóëÔ∏è</button>

    <button v-if="entities.length" class="clear-btn" @click="clearCurrent">üßπ Clear</button>
  </div>

  <!-- ADD ENTITY FORM -->
  <form v-if="!combatStarted" class="add-form" @submit.prevent="addEntity">
    <select v-model="newType"><option>Player</option><option>Monster</option></select>

    <template v-if="newType==='Player'">
      <select v-model="newName">
        <option value="" disabled>Select player‚Ä¶</option>
        <option v-for="p in playerNames" :key="p">{{p}}</option>
        <option value="__custom">Custom name‚Ä¶</option>
      </select>
      <input v-if="newName==='__custom'" v-model="customPlayer" placeholder="Name">
      <input v-model.number="newInitiative" type="number" placeholder="Initiative">
    </template>

    <template v-else>
      <input v-model="newName" placeholder="Monster name" required>
      <select v-model="newColor">
        <option>red</option><option>blue</option><option>yellow</option><option>green</option>
      </select>
      <input v-model.number="newHP" type="number" placeholder="HP">
      <textarea v-model="newStatBlock" placeholder="Stat Block (plain or JSON)"></textarea>
    </template>

    <button type="submit">Add</button>
  </form>

  <!-- COMBAT CONTROLS -->
  <div v-if="entities.length">
    <button v-if="!combatStarted" @click="startCombat" class="big-btn start-btn">Start Combat</button>
    <div v-else>
      <button @click="nextTurn" class="big-btn next-btn">Next Turn</button>
      <button @click="endCombat" class="big-btn end-btn">End Combat</button>
    </div>
  </div>

  <!-- INITIATIVE TABLE -->
  <table v-if="entities.length">
    <thead>
      <tr><th>Init</th><th>Name</th><th>Type / HP</th><th>Status</th><th>Actions</th></tr>
    </thead>
    <tbody>
	<tr v-for="(e,i) in displayOrder" :key="e.id"
    	:class="{active:i===turnIndex,dead:e.type==='Monster' && e.hp!==undefined && e.hp<=0}">

        <td>{{e.initiative}}</td>
        <td><span v-if="e.type==='Monster'" class="color-dot" :style="{backgroundColor:e.color}"></span>{{e.name}}</td>
        <td>
          <template v-if="e.type==='Monster'">
            <div class="hp-wrap"><div class="hp-bar" :style="{width:hpPercent(e)+'%'}"></div></div>
<small>
      <input v-model.number="e.hp"
             type="number"
             style="width:3em;background:transparent;border:none;color:#ff8a80;text-align:right;">
      / {{e.hpMax || '?'}}
    </small>            <div class="stat-sum">
              <div class="stat-box"><b>AC</b>{{e.ac||'‚Äî'}}</div>
              <div class="stat-box"><b>F</b>{{e.fort||'‚Äî'}}</div>
              <div class="stat-box"><b>R</b>{{e.ref||'‚Äî'}}</div>
              <div class="stat-box"><b>W</b>{{e.will||'‚Äî'}}</div>
            </div>
          </template>
          <template v-else>‚Äî</template>
        </td>

        <td>
          <span v-for="(s,idx) in e.statuses" :key="idx"
                class="status-tag" :title="conditionMap[s]||s"
                @click="removeStatus(e,idx)">{{s}} ‚úï</span>

          <template v-if="e._addingStatus">
            <select @change="applyStatus(e,$event)" @blur="e._addingStatus=false">
              <option value="" disabled selected>Add‚Ä¶</option>
              <optgroup v-for="g in groupedConditions" :label="g.label" :key="g.label">
                <option v-for="c in g.items" :key="c.name" :value="c.name">{{c.name}}</option>
              </optgroup>
              <option value="__custom">Custom‚Ä¶</option>
            </select>
          </template>
          <button v-else @click="e._addingStatus=true" title="Add status">Ôºã</button>
        </td>

        <td>
          <button v-if="combatStarted && displayOrder[turnIndex]?.id===e.id"
                  @click="delayTurn(e.id)">Delay</button>
          <button v-if="e.type==='Monster'" @click="showStats(e)">Stats</button>
          <button v-if="e.type==='Monster' && e.hp!==undefined && e.hp<=0"
                  @click="removeEntity(e.id)">Remove</button>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- STAT BLOCK -->
  <div v-if="selectedMonster" class="stat-block">
    <div v-html="selectedMonster.html"></div>
  </div>

  <!-- DELAYED LIST -->
  <div v-if="delayedEntities.length"
       style="margin-top:1em;border-top:1px dashed #555;padding-top:1em;">
    <h3>Delayed</h3>
    <ul>
      <li v-for="e in delayedEntities" :key="e.id">
        {{e.name}} ({{e.type}}) <button @click="resumeTurn(e.id)">Jump In</button>
      </li>
    </ul>
  </div>

  <!-- CURRENT ENCOUNTER EXPORT / IMPORT -->
  <details class="box">
    <summary><strong>Current Encounter</strong></summary>
    <textarea readonly :value="exportJSON()"></textarea>
    <div style="margin:.6em 0">
      <button @click="copyExport">Copy</button>
      <button @click="downloadJSON">Download</button>
    </div>
    <div style="margin:.6em 0"><input type="file" @change="uploadJSON"></div>
    <textarea v-model="importBlob" placeholder="‚Ä¶or paste JSON here"></textarea>
    <button @click="importJSON">Load</button>
  </details>

  <!-- SAVED LIBRARY EXPORT / IMPORT -->
  <details class="box">
    <summary><strong>Saved Library</strong></summary>
    <textarea readonly :value="libraryJSON"></textarea>
    <div style="margin:.6em 0">
      <button @click="copyLibrary">Copy Library</button>
      <button @click="downloadLibrary">üì§ Export Library</button>
    </div>
    <div style="margin:.6em 0"><input type="file" @change="uploadLibrary"></div>
    <textarea v-model="importLibraryBlob" placeholder="‚Ä¶or paste library JSON here"></textarea>
    <button @click="importLibrary">Import Library</button>
  </details>
</div>

<script>
const { createApp } = Vue;

/* ---------- condition master list ---------- */
/* ---------- condition master list ---------- */
const conds = [
  /* üß† Mental / Control */
  {cat:'üß† Mental', name:'Frightened',     desc:'‚Äì status penalty to checks & DCs; reduces 1 each round.'},
  {cat:'üß† Mental', name:'Confused',       desc:'Act randomly; may attack allies.'},
  {cat:'üß† Mental', name:'Fascinated',     desc:'Observe the source only; ‚Äì2 Perception vs. others.'},
  {cat:'üß† Mental', name:'Stupefied',      desc:'Penalty to mental ability checks & spell DCs.'},
  {cat:'üß† Mental', name:'Controlled',     desc:'Another creature directs your actions.'},
  {cat:'üß† Mental', name:'Dazed',          desc:'Can use only 1 action on your turn.'},
  {cat:'üß† Mental', name:'Unconscious',    desc:'Knocked out; helpless until you regain consciousness.'},

  /* ü§ï Physical Afflictions */
  {cat:'ü§ï Physical', name:'Doomed',       desc:'Die at a lower dying value.'},
  {cat:'ü§ï Physical', name:'Dying',        desc:'On the brink of death; make recovery checks.'},
  {cat:'ü§ï Physical', name:'Wounded',      desc:'Dying value increases faster if you fall again.'},
  {cat:'ü§ï Physical', name:'Paralyzed',    desc:'Can‚Äôt act; flat-footed and helpless.'},
  {cat:'ü§ï Physical', name:'Petrified',    desc:'Turned to stone; object.'},
  {cat:'ü§ï Physical', name:'Clumsy',       desc:'Penalty to Dexterity-based checks & DCs.'},
  {cat:'ü§ï Physical', name:'Enfeebled',    desc:'Penalty to Strength-based checks & DCs.'},
  {cat:'ü§ï Physical', name:'Fatigued',     desc:'‚Äì1 to AC & saves; can‚Äôt use exploration activities.'},
  {cat:'ü§ï Physical', name:'Exhausted',    desc:'Severely weakened; usually from narrative effects.'},

  /* üî• Damage-over-Time / Elemental */
  {cat:'üî• DoT', name:'Persistent Damage', desc:'Take damage each round (fire, acid, bleed, etc.) until removed.'},
  {cat:'üî• DoT', name:'Burning',           desc:'Narrative tag for ongoing fire (usually persistent fire).'},

  /* üí¢ Combat Utility / Movement */
  {cat:'üí¢ Combat', name:'Flat-Footed',  desc:'‚Äì2 AC against attacks.'},
  {cat:'üí¢ Combat', name:'Prone',        desc:'On the ground; ‚Äì2 attack rolls; must stand to move normally.'},
  {cat:'üí¢ Combat', name:'Grabbed',      desc:'Immobilized by a foe; flat-footed.'},
  {cat:'üí¢ Combat', name:'Restrained',   desc:'Can‚Äôt act (no Strikes or moves); flat-footed.'},
  {cat:'üí¢ Combat', name:'Immobilized',  desc:'Can‚Äôt move voluntarily.'},
  {cat:'üí¢ Combat', name:'Slowed',       desc:'Lose 1 or more actions each round.'},
  {cat:'üí¢ Combat', name:'Quickened',    desc:'Gain 1 extra action each round (with restrictions).'},
  {cat:'üí¢ Combat', name:'Invisible',    desc:'Can‚Äôt be seen without special senses.'},

  /* üí¨ Speech / Sensory */
  {cat:'üí¨ Sense', name:'Blinded',            desc:'Can‚Äôt see; everything is difficult terrain; flat-footed.'},
  {cat:'üí¨ Sense', name:'Deafened',           desc:'Can‚Äôt hear; ‚Äì2 initiative; risk failure on verbal components.'},
  {cat:'üí¨ Sense', name:'Sensory-Deprived',   desc:'Magical effect disrupting senses (GM‚Äôs discretion).'},

  /* üéØ Targeting & Control */
  {cat:'üéØ Target', name:'Charmed',      desc:'Target treats you as friendly; can‚Äôt act hostile.'},
  {cat:'üéØ Target', name:'Stunned',      desc:'Lose a number of actions equal to the value.'},
  {cat:'üéØ Target', name:'Incapacitated',desc:'Trait‚Äîspells/effects are limited vs. creatures of higher level.'},

  /* üßä Special Combat States */
  {cat:'üßä Special', name:'Encumbered',  desc:'Overloaded; speed reduced.'},
  {cat:'üßä Special', name:'Concealed',   desc:'Attacker must succeed a DC 5 flat check to hit you.'},
  {cat:'üßä Special', name:'Hidden',      desc:'Attacker knows your location but can‚Äôt see you (DC 11 flat check).'},
  {cat:'üßä Special', name:'Undetected',  desc:'Attacker doesn‚Äôt know where you are.'},
  {cat:'üßä Special', name:'Observed',    desc:'You‚Äôre in plain sight; no Stealth benefits.'}
];
const grouped=[],conditionMap={};
conds.forEach(c=>conditionMap[c.name]=c.desc);
for(const gName of [...new Set(conds.map(c=>c.cat))]){
  grouped.push({label:gName,items:conds.filter(c=>c.cat===gName)});
}

createApp({
  data(){
    return{
      entities:[],delayedEntities:[],
      newType:'Player',newName:'',customPlayer:'',
      newInitiative:null,newHP:null,newStatBlock:'',newColor:'red',
      turnIndex:0,combatStarted:false,selectedMonster:null,

      saveName:'',selectedSave:'',
      savedList:JSON.parse(localStorage.getItem('encounterNames')||'[]'),

      importBlob:'',importLibraryBlob:'',
      playerNames:['Ecaon','Buggie','Styx Red-Claw','Vokkar','ObsidianIvy','ElderDan','Trusco'],
      groupedConditions:grouped,conditionMap
    };
  },
  computed:{
    displayOrder(){
      return this.combatStarted
        ? this.entities
        : [...this.entities].sort((a,b)=>b.initiative-a.initiative||a.order-b.order);
    },
    libraryJSON(){
      const slots={};
      this.savedList.forEach(n=>{
        slots[n]=JSON.parse(localStorage.getItem('encounter_'+n)||'null');
      });
      return JSON.stringify({names:this.savedList,slots},null,2);
    }
  },
  methods:{
    d20(){return Math.floor(Math.random()*20)+1;},
    hpPercent(e){if(!e.hpMax)return 0;return Math.max(0,Math.min(100,100*e.hp/e.hpMax));},

    /* ---------------- add / clear ---------------- */
    addEntity(){
      const name=this.newType==='Player'
        ? (this.newName==='__custom'?this.customPlayer:this.newName)
        : this.newName;
      if(!name)return;

      const init=this.newType==='Monster'
        ? (this.newInitiative||this.d20()+5)
        : (this.newInitiative||0);

      this.entities.push({
        id:Date.now()+Math.random(),
        name,initiative:init,type:this.newType,order:this.entities.length,
        hp:this.newHP,hpMax:this.newHP,
        statBlock:this.newStatBlock,color:this.newColor,
        statuses:[],_addingStatus:false,html:'',
        ac:null,fort:null,ref:null,will:null
      });

      this.newName='';this.customPlayer='';
      this.newInitiative=null;this.newHP=null;this.newStatBlock='';this.newColor='red';
    },
    clearCurrent(){
      if(confirm('Really clear current encounter?')){
        this.entities=[];this.delayedEntities=[];
        this.turnIndex=0;this.selectedMonster=null;
      }
    },

    /* ---------------- save / load a slot ---------------- */
    saveEncounter(){
      if(!this.saveName.trim()){alert('Name it first');return;}
      localStorage.setItem('encounter_'+this.saveName,
        JSON.stringify({active:this.entities,delayed:this.delayedEntities}));
      if(!this.savedList.includes(this.saveName)){
        this.savedList.push(this.saveName);
        localStorage.setItem('encounterNames',JSON.stringify(this.savedList));
      }
      this.saveName='';alert('Saved!');
    },
    loadEncounter(){
      if(!this.selectedSave)return;
      const blob=localStorage.getItem('encounter_'+this.selectedSave);
      if(!blob){alert('No data');return;}
      const d=JSON.parse(blob);
      this.entities=d.active||[];this.delayedEntities=d.delayed||[];
      this.turnIndex=0;this.combatStarted=false;this.selectedMonster=null;
    },
    deleteEncounter(){
      if(this.selectedSave&&confirm('Delete ‚Äú‚Äò'+this.selectedSave+'‚Äù ?')){
        localStorage.removeItem('encounter_'+this.selectedSave);
        this.savedList=this.savedList.filter(n=>n!==this.selectedSave);
        localStorage.setItem('encounterNames',JSON.stringify(this.savedList));
        this.selectedSave='';
      }
    },

/* combat flow ---------------------------------------------------- */
startCombat () {
  /* ‚ù∂  extract quick-stats for every monster once */
  this.entities.forEach(e => {
    if (e.type === 'Monster' && (e.ac === null || e.ac === undefined)) {
      this.parseBlock(e);          // fills AC / saves / hpMax, etc.
    }
  });

  /* ‚ù∑  sort & begin combat (unchanged lines) */
  this.entities.sort((a, b) => b.initiative - a.initiative || a.order - b.order);
  this.combatStarted = true;
  this.turnIndex = 0;
  this.syncStatBlock();
},
    nextTurn(){
      if(this.entities.length){
        this.turnIndex=(this.turnIndex+1)%this.entities.length;
        this.syncStatBlock();
      }
    },
    endCombat(){this.entities=[];this.delayedEntities=[];this.turnIndex=0;this.combatStarted=false;this.selectedMonster=null;},
    delayTurn(id){
      const i=this.entities.findIndex(e=>e.id===id);
      if(i!==-1){
        this.delayedEntities.push(this.entities.splice(i,1)[0]);
        if(this.turnIndex>=this.entities.length) this.turnIndex=0;
        this.syncStatBlock();
      }
    },
    resumeTurn(id){
      const i=this.delayedEntities.findIndex(e=>e.id===id);
      if(i!==-1){
        const ent=this.delayedEntities.splice(i,1)[0];
        const activeId=this.displayOrder[this.turnIndex]?.id;
        const ins=this.entities.findIndex(e=>e.id===activeId);
        this.entities.splice(ins,0,ent);
        this.turnIndex=ins;this.syncStatBlock();
      }
    },

    /* ---------------- status handling ---------------- */
    applyStatus(ent,ev){
      const val=ev.target.value;
      ent._addingStatus=false;
      if(!val)return;
      if(val==='__custom'){
        const c=prompt('Custom status'); if(c) ent.statuses.push(c);
      }else ent.statuses.push(val);
    },
    removeStatus(ent,i){ent.statuses.splice(i,1);},

    /* ---------------- stat-block parsing & rendering ---------------- */
    showStats(ent){this.parseBlock(ent);this.selectedMonster=ent;},
    syncStatBlock(){
      const cur=this.entities[this.turnIndex];
      if(cur) this.parseBlock(cur);
      this.selectedMonster=(cur&&cur.type==='Monster')?cur:null;
    },
    parseBlock(mon){
      try{
        const o=typeof mon.statBlock==='string'?JSON.parse(mon.statBlock):mon.statBlock;
        mon.html=this.buildCard(o);
        mon.ac=o.ac||null;
        mon.fort=o.saves?.Fort||null;
        mon.ref=o.saves?.Ref||null;
        mon.will=o.saves?.Will||null;
        mon.hpMax=mon.hpMax||o.hp||mon.hp;
      }catch{
        mon.html=`<pre>${(mon.statBlock||'').replace(/</g,"&lt;")}</pre>`;
        if(mon.ac==null){mon.ac=mon.fort=mon.ref=mon.will=null;}
      }
    },
    buildTag(lbl,cls){cls=cls||lbl.replace(/\\s+/g,'');return `<span class="tag-${cls}">${lbl}</span>`;},
    buildCard(o){
      const tags=`<div class="stat-tags">
        ${o.alignment?this.buildTag(o.alignment):''}
        ${o.size?this.buildTag(o.size):''}
        ${(o.traits||[]).map(t=>this.buildTag(t)).join('')}
      </div>`;
      const head=`<h4>${o.name||'Creature'} <span style="float:right">CR ${o.level??'?'}</span></h4>${tags}`;
      const senses=`<b>Perception</b> ${o.perception||''}${o.senses?'; '+o.senses.join(', '):''}`;
      const skills=o.skills?`<b>Skills</b> ${Object.entries(o.skills).map(([k,v])=>k+' '+v).join(', ')}`:'';
      const ability=o.abilities?Object.entries(o.abilities).map(([k,v])=>`${k} ${v}`).join(', '):'';
      const saves=o.saves?`<b>Fort</b> ${o.saves.Fort||''}, <b>Ref</b> ${o.saves.Ref||''}, <b>Will</b> ${o.saves.Will||''}`:'';
      const res=o.resist?`<b>Resist</b> ${fmt(o.resist)}`:'';
      const weak=o.weak?`<b>Weak</b> ${fmt(o.weak)}`:'';
      function fmt(obj){return Object.entries(obj).map(([k,v])=>k+' '+v).join(', ');}
      const melee=(o.melee||[]).map(m=>
        `<li><b>Melee</b> ${m.name} ${m.attack||''}${m.traits?' ('+m.traits+')':''}, <i>Damage</i> ${m.damage}</li>`
      ).join('');
      const acts=(o.actions||[]).map(a=>{
        const icon=a.type==='three'?'‚óÜ‚óÜ‚óÜ':a.type==='two'?'‚óÜ‚óÜ':'‚óÜ';
        const cls=a.type==='three'?'act-three':a.type==='two'?'act-two':'act-single';
        return `<div><span class="action-icon ${cls}">${icon}</span><b>${a.name}.</b> ${a.text}</div>`;
      }).join('');
      const desc=o.description?`<div class="stat-section">${o.description}</div>`:'';
      return `<div class="stat-card">${head}
        <div class="stat-section">${senses}</div>
        <div class="stat-section">${skills}<br>${ability}</div>
        <div class="stat-section">AC ${o.ac||''}; ${saves}<br><b>HP</b> ${o.hp||''} ${res?'; '+res:''} ${weak?'; '+weak:''}</div>
        <div class="stat-section"><b>Speed</b> ${o.speed||'‚Äî'} ft</div>
        <ul>${melee}</ul>${acts}${desc}
      </div>`;
    },

    /* ---------------- remove monster ---------------- */
    removeEntity(id){
      this.entities=this.entities.filter(e=>e.id!==id);
      this.delayedEntities=this.delayedEntities.filter(e=>e.id!==id);
      if(this.turnIndex>=this.entities.length) this.turnIndex=0;
      if(this.selectedMonster && this.selectedMonster.id===id) this.selectedMonster=null;
    },

    /* ---------------- current encounter import / export ---------------- */
    exportJSON(){return JSON.stringify({active:this.entities,delayed:this.delayedEntities},null,2);},
    copyExport(){navigator.clipboard.writeText(this.exportJSON()).then(()=>alert('Copied!'));},
    downloadJSON(){
      const blob=new Blob([this.exportJSON()],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      Object.assign(document.createElement('a'),{href:url,download:'encounter.json'}).click();
      URL.revokeObjectURL(url);
    },
    uploadJSON(ev){
      const f=ev.target.files[0]; if(!f)return;
      const r=new FileReader(); r.onload=e=>this.importBlob=e.target.result; r.readAsText(f);
    },
    importJSON(){
      try{
        const d=JSON.parse(this.importBlob||'{}');
        this.entities=d.active||[]; this.delayedEntities=d.delayed||[];
        this.turnIndex=0; this.combatStarted=false; this.selectedMonster=null;
      }catch{ alert('Invalid JSON'); }
    },

    /* ---------------- library import / export ---------------- */
    copyLibrary(){navigator.clipboard.writeText(this.libraryJSON).then(()=>alert('Copied library!'));},
    downloadLibrary(){
      const blob=new Blob([this.libraryJSON],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      Object.assign(document.createElement('a'),{href:url,download:'encounter_library.json'}).click();
      URL.revokeObjectURL(url);
    },
    uploadLibrary(ev){
      const f=ev.target.files[0]; if(!f)return;
      const r=new FileReader(); r.onload=e=>this.importLibraryBlob=e.target.result; r.readAsText(f);
    },
    importLibrary(){
      try{
        const lib=JSON.parse(this.importLibraryBlob||'{}');
        if(!Array.isArray(lib.names)||typeof lib.slots!=='object') throw 0;
        lib.names.forEach(n=>{
          localStorage.setItem('encounter_'+n,JSON.stringify(lib.slots[n]));
          if(!this.savedList.includes(n)) this.savedList.push(n);
        });
        localStorage.setItem('encounterNames',JSON.stringify(this.savedList));
        alert('Library imported!');
      }catch{alert('Invalid library JSON');}
    }
  }
}).mount('#app');
</script>
</body>
</html>
